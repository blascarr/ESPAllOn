<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ESPAllOn - Proyectos</title>
		<link rel="stylesheet" href="/css/normalize.css" />
		<link rel="stylesheet" href="/css/style.css" />
		<link rel="stylesheet" href="/projects.css" />
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>üöÄ Gesti√≥n de Proyectos</h1>
				<p>Selecciona y carga configuraciones de proyectos desde la API</p>
			</div>

			<div class="controls">
				<a href="/" class="btn btn-primary">üè† Volver al Panel Principal</a>
				<button
					id="refreshBtn"
					class="btn btn-primary"
					onclick="loadProjects()"
				>
					<span id="refreshIcon">üîÑ</span> Actualizar Proyectos
				</button>
				<button
					id="loadConfigBtn"
					class="btn btn-success"
					onclick="loadSelectedProject()"
					disabled
				>
					<span id="loadIcon">‚öôÔ∏è</span> Cargar Configuraci√≥n
				</button>
			</div>

			<div id="status" class="status" style="display: none"></div>

			<div id="projectsContainer" class="projects-grid">
				<div class="empty-state">
					<h3>üëã ¬°Bienvenido!</h3>
					<p>
						Haz clic en "Actualizar Proyectos" para cargar los proyectos
						disponibles desde la API.
					</p>
				</div>
			</div>
		</div>

		<script>
			let projects = [];
			let selectedProjectId = null;

			// Show status message
			function showStatus(message, type = 'loading') {
				const statusEl = document.getElementById('status');
				statusEl.textContent = message;
				statusEl.className = `status ${type}`;
				statusEl.style.display = 'block';

				if (type === 'success' || type === 'error') {
					setTimeout(() => {
						statusEl.style.display = 'none';
					}, 5000);
				}
			}

			// Load projects from API
			async function loadProjects() {
				const refreshBtn = document.getElementById('refreshBtn');
				const refreshIcon = document.getElementById('refreshIcon');

				refreshBtn.disabled = true;
				refreshIcon.innerHTML = '<div class="loading-spinner"></div>';

				showStatus('Cargando proyectos desde la API...', 'loading');

				try {
					const response = await fetch('/api/projects');

					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}

					const data = await response.json();

					if (data.success && data.data) {
						projects = data.data;
						displayProjects(projects);
						showStatus(
							`‚úÖ ${projects.length} proyectos cargados exitosamente`,
							'success'
						);
					} else {
						throw new Error('Respuesta de API inv√°lida');
					}
				} catch (error) {
					console.error('Error loading projects:', error);
					showStatus(`‚ùå Error al cargar proyectos: ${error.message}`, 'error');
					displayEmptyState();
				} finally {
					refreshBtn.disabled = false;
					refreshIcon.textContent = 'üîÑ';
				}
			}

			// Display projects in grid
			function displayProjects(projectsList) {
				const container = document.getElementById('projectsContainer');

				if (projectsList.length === 0) {
					displayEmptyState();
					return;
				}

				container.innerHTML = projectsList
					.map(
						(project) => `
                <div class="project-card" onclick="selectProject('${
									project.id
								}')">
                    <div class="project-title">${escapeHtml(project.name)}</div>
                    <div class="project-description">${escapeHtml(
											project.description
										)}</div>
                    
                    <div class="project-meta">
                        <span class="project-status status-${project.status}">
                            ${getStatusIcon(project.status)} ${project.status}
                        </span>
                        <span class="project-date">
                            ${formatDate(project.updated_at)}
                        </span>
                    </div>
                    
                    ${
											project.config && project.config.config
												? `
                        <div class="config-preview">
                            <strong>üìã Configuraci√≥n:</strong>
                            ${project.config.config
															.slice(0, 3)
															.map(
																(item) => `
                                <div class="config-item">
                                    ‚Ä¢ ${item.ID || 'Item'}: ${
																	item.ESPinner_Mod || 'N/A'
																}
                                </div>
                            `
															)
															.join('')}
                            ${
															project.config.config.length > 3
																? `
                                <div class="config-item">... y ${
																	project.config.config.length - 3
																} m√°s</div>
                            `
																: ''
														}
                        </div>
                    `
												: ''
										}
                </div>
            `
					)
					.join('');
			}

			// Display empty state
			function displayEmptyState() {
				const container = document.getElementById('projectsContainer');
				container.innerHTML = `
                <div class="empty-state">
                    <h3>üì≠ No hay proyectos disponibles</h3>
                    <p>No se encontraron proyectos en la API o hubo un error al cargarlos.</p>
                </div>
            `;
			}

			// Select a project
			function selectProject(projectId) {
				selectedProjectId = projectId;

				// Update visual selection
				document.querySelectorAll('.project-card').forEach((card) => {
					card.classList.remove('selected');
				});

				event.currentTarget.classList.add('selected');

				// Enable load config button
				document.getElementById('loadConfigBtn').disabled = false;

				const project = projects.find((p) => p.id === projectId);
				showStatus(`‚úÖ Proyecto seleccionado: ${project.name}`, 'success');
			}

			// Load selected project configuration
			async function loadSelectedProject() {
				if (!selectedProjectId) {
					showStatus('‚ùå No hay proyecto seleccionado', 'error');
					return;
				}

				const loadBtn = document.getElementById('loadConfigBtn');
				const loadIcon = document.getElementById('loadIcon');

				loadBtn.disabled = true;
				loadIcon.innerHTML = '<div class="loading-spinner"></div>';

				const project = projects.find((p) => p.id === selectedProjectId);
				showStatus(`Cargando configuraci√≥n de: ${project.name}...`, 'loading');

				try {
					const response = await fetch(
						`/api/project/${selectedProjectId}/load`,
						{
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
						}
					);

					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}

					const result = await response.json();

					if (result.success) {
						showStatus(
							`üéâ Configuraci√≥n cargada exitosamente: ${project.name}`,
							'success'
						);
					} else {
						throw new Error(result.message || 'Error desconocido');
					}
				} catch (error) {
					console.error('Error loading project config:', error);
					showStatus(
						`‚ùå Error al cargar configuraci√≥n: ${error.message}`,
						'error'
					);
				} finally {
					loadBtn.disabled = false;
					loadIcon.textContent = '‚öôÔ∏è';
				}
			}

			// Utility functions
			function escapeHtml(text) {
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			function getStatusIcon(status) {
				switch (status) {
					case 'active':
						return 'üü¢';
					case 'completed':
						return '‚úÖ';
					case 'inactive':
						return 'üî¥';
					default:
						return '‚ö™';
				}
			}

			function formatDate(dateString) {
				try {
					const date = new Date(dateString);
					return date.toLocaleDateString('es-ES', {
						year: 'numeric',
						month: 'short',
						day: 'numeric',
					});
				} catch {
					return 'Fecha inv√°lida';
				}
			}

			// Auto-load projects on page load
			document.addEventListener('DOMContentLoaded', function () {
				// Optional: Auto-load projects when page loads
				// loadProjects();
			});
		</script>

		<!-- ESPUI Scripts for enhanced functionality -->
		<script src="/js/zepto.min.js"></script>
		<script src="/js/controls.js"></script>
		<script src="/js/slider.js"></script>
		<script src="/js/graph.js"></script>
		<script src="/js/tabbedcontent.js"></script>
	</body>
</html>
