<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ESPAllOn - Proyectos</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				padding: 20px;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				background: white;
				border-radius: 15px;
				box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
				overflow: hidden;
			}

			.header {
				background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
				color: white;
				padding: 30px;
				text-align: center;
			}

			.header h1 {
				font-size: 2.5em;
				margin-bottom: 10px;
			}

			.header p {
				font-size: 1.1em;
				opacity: 0.9;
			}

			.controls {
				padding: 30px;
				background: #f8f9fa;
				border-bottom: 1px solid #e9ecef;
				display: flex;
				justify-content: space-between;
				align-items: center;
				flex-wrap: wrap;
				gap: 15px;
			}

			.btn {
				padding: 12px 24px;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-size: 16px;
				font-weight: 600;
				transition: all 0.3s ease;
				text-decoration: none;
				display: inline-block;
			}

			.btn-primary {
				background: linear-gradient(135deg, #3498db, #2980b9);
				color: white;
			}

			.btn-primary:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
			}

			.btn-success {
				background: linear-gradient(135deg, #27ae60, #229954);
				color: white;
			}

			.btn-success:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
			}

			.btn:disabled {
				opacity: 0.6;
				cursor: not-allowed;
				transform: none !important;
			}

			.status {
				padding: 15px 30px;
				font-weight: 600;
				text-align: center;
				border-bottom: 1px solid #e9ecef;
			}

			.status.loading {
				background: #fff3cd;
				color: #856404;
			}

			.status.success {
				background: #d4edda;
				color: #155724;
			}

			.status.error {
				background: #f8d7da;
				color: #721c24;
			}

			.projects-grid {
				padding: 30px;
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
				gap: 20px;
			}

			.project-card {
				border: 2px solid #e9ecef;
				border-radius: 12px;
				padding: 25px;
				transition: all 0.3s ease;
				cursor: pointer;
				background: white;
			}

			.project-card:hover {
				border-color: #3498db;
				transform: translateY(-5px);
				box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
			}

			.project-card.selected {
				border-color: #27ae60;
				background: #f8fff9;
				box-shadow: 0 8px 25px rgba(39, 174, 96, 0.2);
			}

			.project-title {
				font-size: 1.4em;
				font-weight: 700;
				color: #2c3e50;
				margin-bottom: 10px;
			}

			.project-description {
				color: #7f8c8d;
				margin-bottom: 15px;
				line-height: 1.5;
			}

			.project-meta {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-top: 15px;
				padding-top: 15px;
				border-top: 1px solid #ecf0f1;
			}

			.project-status {
				padding: 5px 12px;
				border-radius: 20px;
				font-size: 0.85em;
				font-weight: 600;
				text-transform: uppercase;
			}

			.status-active {
				background: #d4edda;
				color: #155724;
			}

			.status-completed {
				background: #cce7ff;
				color: #004085;
			}

			.status-inactive {
				background: #f8d7da;
				color: #721c24;
			}

			.project-date {
				font-size: 0.9em;
				color: #95a5a6;
			}

			.config-preview {
				margin-top: 15px;
				padding: 15px;
				background: #f8f9fa;
				border-radius: 8px;
				border-left: 4px solid #3498db;
			}

			.config-item {
				font-size: 0.9em;
				color: #5a6c7d;
				margin-bottom: 5px;
			}

			.loading-spinner {
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 3px solid #f3f3f3;
				border-top: 3px solid #3498db;
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin-right: 10px;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.empty-state {
				text-align: center;
				padding: 60px 30px;
				color: #7f8c8d;
			}

			.empty-state h3 {
				font-size: 1.5em;
				margin-bottom: 15px;
			}

			@media (max-width: 768px) {
				.container {
					margin: 10px;
					border-radius: 10px;
				}

				.header {
					padding: 20px;
				}

				.header h1 {
					font-size: 2em;
				}

				.controls {
					padding: 20px;
					flex-direction: column;
					align-items: stretch;
				}

				.projects-grid {
					grid-template-columns: 1fr;
					padding: 20px;
				}

				.project-card {
					padding: 20px;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>üöÄ Gesti√≥n de Proyectos</h1>
				<p>Selecciona y carga configuraciones de proyectos desde la API</p>
			</div>

			<div class="controls">
				<button
					id="refreshBtn"
					class="btn btn-primary"
					onclick="loadProjects()"
				>
					<span id="refreshIcon">üîÑ</span> Actualizar Proyectos
				</button>
				<button
					id="loadConfigBtn"
					class="btn btn-success"
					onclick="loadSelectedProject()"
					disabled
				>
					<span id="loadIcon">‚öôÔ∏è</span> Cargar Configuraci√≥n
				</button>
			</div>

			<div id="status" class="status" style="display: none"></div>

			<div id="projectsContainer" class="projects-grid">
				<div class="empty-state">
					<h3>üëã ¬°Bienvenido!</h3>
					<p>
						Haz clic en "Actualizar Proyectos" para cargar los proyectos
						disponibles desde la API.
					</p>
				</div>
			</div>
		</div>

		<script>
			let projects = [];
			let selectedProjectId = null;

			// Show status message
			function showStatus(message, type = 'loading') {
				const statusEl = document.getElementById('status');
				statusEl.textContent = message;
				statusEl.className = `status ${type}`;
				statusEl.style.display = 'block';

				if (type === 'success' || type === 'error') {
					setTimeout(() => {
						statusEl.style.display = 'none';
					}, 5000);
				}
			}

			// Load projects from API
			async function loadProjects() {
				const refreshBtn = document.getElementById('refreshBtn');
				const refreshIcon = document.getElementById('refreshIcon');

				refreshBtn.disabled = true;
				refreshIcon.innerHTML = '<div class="loading-spinner"></div>';

				showStatus('Cargando proyectos desde la API...', 'loading');

				try {
					const response = await fetch('/api/projects');

					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}

					const data = await response.json();

					if (data.success && data.data) {
						projects = data.data;
						displayProjects(projects);
						showStatus(
							`‚úÖ ${projects.length} proyectos cargados exitosamente`,
							'success'
						);
					} else {
						throw new Error('Respuesta de API inv√°lida');
					}
				} catch (error) {
					console.error('Error loading projects:', error);
					showStatus(`‚ùå Error al cargar proyectos: ${error.message}`, 'error');
					displayEmptyState();
				} finally {
					refreshBtn.disabled = false;
					refreshIcon.textContent = 'üîÑ';
				}
			}

			// Display projects in grid
			function displayProjects(projectsList) {
				const container = document.getElementById('projectsContainer');

				if (projectsList.length === 0) {
					displayEmptyState();
					return;
				}

				container.innerHTML = projectsList
					.map(
						(project) => `
                <div class="project-card" onclick="selectProject('${
									project.id
								}')">
                    <div class="project-title">${escapeHtml(project.name)}</div>
                    <div class="project-description">${escapeHtml(
											project.description
										)}</div>
                    
                    <div class="project-meta">
                        <span class="project-status status-${project.status}">
                            ${getStatusIcon(project.status)} ${project.status}
                        </span>
                        <span class="project-date">
                            ${formatDate(project.updated_at)}
                        </span>
                    </div>
                    
                    ${
											project.config && project.config.config
												? `
                        <div class="config-preview">
                            <strong>üìã Configuraci√≥n:</strong>
                            ${project.config.config
															.slice(0, 3)
															.map(
																(item) => `
                                <div class="config-item">
                                    ‚Ä¢ ${item.ID || 'Item'}: ${
																	item.ESPinner_Mod || 'N/A'
																}
                                </div>
                            `
															)
															.join('')}
                            ${
															project.config.config.length > 3
																? `
                                <div class="config-item">... y ${
																	project.config.config.length - 3
																} m√°s</div>
                            `
																: ''
														}
                        </div>
                    `
												: ''
										}
                </div>
            `
					)
					.join('');
			}

			// Display empty state
			function displayEmptyState() {
				const container = document.getElementById('projectsContainer');
				container.innerHTML = `
                <div class="empty-state">
                    <h3>üì≠ No hay proyectos disponibles</h3>
                    <p>No se encontraron proyectos en la API o hubo un error al cargarlos.</p>
                </div>
            `;
			}

			// Select a project
			function selectProject(projectId) {
				selectedProjectId = projectId;

				// Update visual selection
				document.querySelectorAll('.project-card').forEach((card) => {
					card.classList.remove('selected');
				});

				event.currentTarget.classList.add('selected');

				// Enable load config button
				document.getElementById('loadConfigBtn').disabled = false;

				const project = projects.find((p) => p.id === projectId);
				showStatus(`‚úÖ Proyecto seleccionado: ${project.name}`, 'success');
			}

			// Load selected project configuration
			async function loadSelectedProject() {
				if (!selectedProjectId) {
					showStatus('‚ùå No hay proyecto seleccionado', 'error');
					return;
				}

				const loadBtn = document.getElementById('loadConfigBtn');
				const loadIcon = document.getElementById('loadIcon');

				loadBtn.disabled = true;
				loadIcon.innerHTML = '<div class="loading-spinner"></div>';

				const project = projects.find((p) => p.id === selectedProjectId);
				showStatus(`Cargando configuraci√≥n de: ${project.name}...`, 'loading');

				try {
					const response = await fetch(
						`/api/project/${selectedProjectId}/load`,
						{
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
						}
					);

					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}

					const result = await response.json();

					if (result.success) {
						showStatus(
							`üéâ Configuraci√≥n cargada exitosamente: ${project.name}`,
							'success'
						);
					} else {
						throw new Error(result.message || 'Error desconocido');
					}
				} catch (error) {
					console.error('Error loading project config:', error);
					showStatus(
						`‚ùå Error al cargar configuraci√≥n: ${error.message}`,
						'error'
					);
				} finally {
					loadBtn.disabled = false;
					loadIcon.textContent = '‚öôÔ∏è';
				}
			}

			// Utility functions
			function escapeHtml(text) {
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			function getStatusIcon(status) {
				switch (status) {
					case 'active':
						return 'üü¢';
					case 'completed':
						return '‚úÖ';
					case 'inactive':
						return 'üî¥';
					default:
						return '‚ö™';
				}
			}

			function formatDate(dateString) {
				try {
					const date = new Date(dateString);
					return date.toLocaleDateString('es-ES', {
						year: 'numeric',
						month: 'short',
						day: 'numeric',
					});
				} catch {
					return 'Fecha inv√°lida';
				}
			}

			// Auto-load projects on page load
			document.addEventListener('DOMContentLoaded', function () {
				// Optional: Auto-load projects when page loads
				// loadProjects();
			});
		</script>
	</body>
</html>
